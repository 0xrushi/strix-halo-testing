:8080 {
    # Enable CORS for all
    @options method OPTIONS
    handle @options {
        header Access-Control-Allow-Origin "{http.request.header.Origin}"
        header Access-Control-Allow-Methods "GET, POST, OPTIONS"
        header Access-Control-Allow-Headers "Authorization, Content-Type"
        header Access-Control-Allow-Credentials "true"
        respond "" 204
    }
    
    # Handle authentication with custom error response
    basicauth {
        admin {env.BASIC_AUTH_HASH}
    }
    
    # Handle authentication failure
    handle_errors {
        @auth_error expression {http.error.status_code} == 401
        handle @auth_error {
            header Access-Control-Allow-Origin "{http.request.header.Origin}"
            header Access-Control-Allow-Credentials "true"
            header Content-Type "application/json"
            respond `{"error": "Invalid credentials", "message": "Authentication failed"}` 401
        }
        
        header Access-Control-Allow-Origin "{http.request.header.Origin}"
        header Access-Control-Allow-Credentials "true"
        respond "An error occurred" {http.error.status_code}
    }
    
    # Set CORS headers for successful requests
    header Access-Control-Allow-Origin "{http.request.header.Origin}"
    
    # Proxy to backend
    reverse_proxy host.containers.internal:9000
}